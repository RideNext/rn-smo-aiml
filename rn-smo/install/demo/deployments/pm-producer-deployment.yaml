apiVersion: v1
kind: ConfigMap
metadata:
  name: pm-producer-script
  namespace: ridenext-nonrt
data:
  pm-data-producer.py: |
    #!/usr/bin/env python3
    """
    PM Data Producer for Energy Saving rApp Demo
    Produces realistic PM data to Kafka pmreports topic
    """

    import json
    import time
    import random
    from datetime import datetime
    from kafka import KafkaProducer
    import logging

    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)

    # Kafka Configuration
    KAFKA_BOOTSTRAP = "kafka-1-kafka-bootstrap.ridenext-nonrt:9092"
    TOPIC = "pmreports"

    # Network Configuration - 15 cells across 5 gNBs
    CELLS = []
    for gnb_idx in range(1, 6):
        for cell_idx in range(1, 4):
            base_util = random.choice([15, 45, 75])
            CELLS.append({
                "cell_id": f"ManagedElement={gnb_idx},GNBDUFunction=1,NRCellDU=Cell-{(gnb_idx-1)*3 + cell_idx}",
                "global_cell_id": f"460-01-{gnb_idx:05d}-{cell_idx:02d}",
                "sector_id": f"Sector-{cell_idx}",
                "pci": 100 + (gnb_idx-1)*3 + cell_idx,
                "base_util": base_util,
                "gnb_id": gnb_idx
            })

    def create_producer():
        max_retries = 5
        retry_delay = 2
        
        for attempt in range(max_retries):
            try:
                producer = KafkaProducer(
                    bootstrap_servers=KAFKA_BOOTSTRAP,
                    value_serializer=lambda v: json.dumps(v).encode('utf-8'),
                    acks='all',
                    retries=3,
                    max_in_flight_requests_per_connection=1
                )
                logger.info(f"âœ“ Connected to Kafka at {KAFKA_BOOTSTRAP}")
                return producer
            except Exception as e:
                logger.error(f"Connection attempt {attempt + 1}/{max_retries} failed: {e}")
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                else:
                    raise

    def generate_pm_data(cell):
        utilization = cell["base_util"] + random.uniform(-15, 15)
        if random.random() < 0.1:
            utilization = random.uniform(0, 100)
        utilization = max(0, min(100, utilization))
        
        pm_data = {
            "cell_id": cell["cell_id"],
            "global_cell_id": cell["global_cell_id"],
            "sector_id": cell["sector_id"],
            "pci": cell["pci"],
            "utilization": round(utilization, 2),
            "timestamp": datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
            "metrics": {
                "prb_utilization_dl": round(utilization, 2),
                "prb_utilization_ul": round(utilization * 0.7, 2),
                "active_ues": int(utilization / 5),
                "throughput_dl_mbps": round(utilization * 10, 2),
                "throughput_ul_mbps": round(utilization * 5, 2),
                "cqi_avg": round(8 + random.uniform(-2, 2), 1),
                "rsrp_avg": round(-85 + random.uniform(-10, 10), 1)
            }
        }
        return pm_data

    def main():
        logger.info("=" * 70)
        logger.info("PM Data Producer for Energy Saving rApp Demo")
        logger.info("=" * 70)
        
        producer = create_producer()
        logger.info("ðŸš€ Starting PM data production...")
        
        message_count = 0
        cycle = 0
        
        try:
            while True:
                cycle += 1
                for cell in CELLS:
                    pm_data = generate_pm_data(cell)
                    future = producer.send(TOPIC, value=pm_data)
                    try:
                        future.get(timeout=10)
                        message_count += 1
                        if message_count % 15 == 0:
                            logger.info(f"Cycle {cycle} complete. Total: {message_count}")
                    except Exception as e:
                        logger.error(f"Failed: {e}")
                time.sleep(2)
        except KeyboardInterrupt:
            logger.info("Stopping...")
        finally:
            producer.flush()
            producer.close()

    if __name__ == "__main__":
        main()
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pm-data-producer
  namespace: ridenext-nonrt
  labels:
    app: pm-data-producer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pm-data-producer
  template:
    metadata:
      labels:
        app: pm-data-producer
    spec:
      containers:
      - name: producer
        image: python:3.10-slim
        command: ["/bin/bash", "-c"]
        args:
          - |
            pip install kafka-python
            python /app/pm-data-producer.py
        volumeMounts:
        - name: script
          mountPath: /app
        env:
        - name: KAFKA_BOOTSTRAP
          value: "kafka-1-kafka-bootstrap.ridenext-nonrt:9092"
      volumes:
      - name: script
        configMap:
          name: pm-producer-script
          defaultMode: 0755
